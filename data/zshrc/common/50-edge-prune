# Delete Edge history only for domains listed in ~/.edge-history-whitelist (or a file you pass as $1)
edgeprune() {
  set -euo pipefail

  # Whitelist path
  WL_FILE="${1:-$HOME/.edge-history-whitelist}"
  [ -f "$WL_FILE" ] || { echo "Whitelist file not found: $WL_FILE"; return 2; }

  # Detect default Edge profile per OS; override with EDGE_PROFILE if you want a different profile
  case "$(uname -s)" in
    Darwin) PROFILE_DEFAULT="$HOME/Library/Application Support/Microsoft Edge/Default" ;;
    Linux)  PROFILE_DEFAULT="$HOME/.config/microsoft-edge/Default" ;;
    *) echo "Unsupported OS"; return 3 ;;
  esac
  PROFILE="${EDGE_PROFILE:-$PROFILE_DEFAULT}"

  DB="$PROFILE/History"
  [ -f "$DB" ] || { echo "History DB not found: $DB"; return 4; }

  # Preview mode? (just shows what would be deleted)
  PREVIEW="${EDGE_PREVIEW:-}"
  if [ "${1:-}" = "--preview" ]; then PREVIEW=1; WL_FILE="${2:-$HOME/.edge-history-whitelist}"; fi

  # Ensure Edge isnâ€™t locking the DB
  pkill -x "Microsoft Edge" microsoft-edge microsoft-edge-stable microsoft-edge-beta microsoft-edge-dev 2>/dev/null || true

  # Quick backup
  cp -a -- "$DB" "$DB.$(date +%Y%m%d%H%M%S).bak"

  # If WAL in use, checkpoint it
  if [ -f "$DB-wal" ] || [ -f "$DB-shm" ]; then sqlite3 "$DB" "PRAGMA wal_checkpoint(TRUNCATE);" >/dev/null; fi

  # Build SQL batch
  TMP_SQL="$(mktemp)"
  {
    echo "BEGIN IMMEDIATE;"
    while IFS= read -r domain; do
      # Skip blanks/comments; only allow sane domain chars
      domain="${domain%%#*}"; domain="${domain//[[:space:]]/}"
      [ -z "$domain" ] && continue
      if ! [[ "$domain" =~ ^[A-Za-z0-9.-]+$ ]]; then
        echo "-- skipping suspicious line: $domain" >&2
        continue
      fi

      # Match http/https, exact domain and any subdomain
      like_exact="http%://$domain/%"
      like_sub="http%://%.$domain/%"

      if [ -n "$PREVIEW" ]; then
        echo "SELECT '== '||quote('$domain')||' matches ==';"
        echo "SELECT COUNT(*)||' urls' FROM urls WHERE url LIKE '$like_exact' OR url LIKE '$like_sub';"
        echo "SELECT COUNT(*)||' visits' FROM visits WHERE url IN (SELECT id FROM urls WHERE url LIKE '$like_exact' OR url LIKE '$like_sub');"
        echo "SELECT COUNT(*)||' keyword terms' FROM keyword_search_terms WHERE url_id IN (SELECT id FROM urls WHERE url LIKE '$like_exact' OR url LIKE '$like_sub');"
        echo "SELECT COUNT(*)||' visit_source rows' FROM visit_source WHERE id IN (SELECT v.id FROM visits v JOIN urls u ON v.url=u.id WHERE u.url LIKE '$like_exact' OR u.url LIKE '$like_sub');"
        echo "SELECT COUNT(*)||' edge_visits rows' FROM edge_visits WHERE visit_id IN (SELECT v.id FROM visits v JOIN urls u ON v.url=u.id WHERE u.url LIKE '$like_exact' OR u.url LIKE '$like_sub');"
      else
        # Clean auxiliary tables first, then visits, then urls
        echo "DELETE FROM visit_source WHERE id IN (SELECT v.id FROM visits v JOIN urls u ON v.url=u.id WHERE u.url LIKE '$like_exact' OR u.url LIKE '$like_sub');"
        echo "DELETE FROM edge_visits WHERE visit_id IN (SELECT v.id FROM visits v JOIN urls u ON v.url=u.id WHERE u.url LIKE '$like_exact' OR u.url LIKE '$like_sub');"
        echo "DELETE FROM keyword_search_terms WHERE url_id IN (SELECT id FROM urls WHERE url LIKE '$like_exact' OR url LIKE '$like_sub');"
        echo "DELETE FROM visits WHERE url IN (SELECT id FROM urls WHERE url LIKE '$like_exact' OR url LIKE '$like_sub');"
        echo "DELETE FROM urls WHERE url LIKE '$like_exact' OR url LIKE '$like_sub';"
      fi
    done < "$WL_FILE"

    if [ -n "$PREVIEW" ]; then
      echo "ROLLBACK;"
    else
      echo "COMMIT; VACUUM;";
    fi
  } > "$TMP_SQL"

  sqlite3 "$DB" < "$TMP_SQL"
  rm -f "$TMP_SQL"

  if [ -n "$PREVIEW" ]; then
    echo "Preview complete. Set EDGE_PREVIEW= (or omit --preview) to actually delete."
  else
    echo "Done. History pruned for domains in $WL_FILE"
  fi
}
